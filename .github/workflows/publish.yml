name: Publish Extension

on:
  workflow_dispatch:  # 手动触发
  push:
    tags:
      - 'v*'  # 当推送版本标签时自动发布

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - run: npm ci
      
      - run: npm run compile
      
      - name: Check version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $VERSION"
          echo "⚠️  请确保已更新 package.json 中的 version 字段"
      
      - name: Package VSIX
        run: npx vsce package --no-dependencies
      
      - name: Publish to VS Code Marketplace
        run: npx vsce publish --no-dependencies
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
      
      - name: Create Open VSX namespace (if needed)
        run: |
          # 静默创建 namespace，如果已存在则忽略
          npx ovsx create-namespace all-for-freedom > /dev/null 2>&1 || echo "Namespace already exists or created successfully"
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        continue-on-error: true
      
      - name: Publish to Open VSX Registry
        run: npx ovsx publish --no-dependencies
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
